---
- name: install requirements
  hosts: 
  - workers
  - controller
  become: true
  tasks:
  - name: Install base packages
    ansible.builtin.apt:
        pkg:
            -  curl 
            - apt-transport-https
            - ca-certificates 
            - gnupg 
            - lsb-release
        update_cache: yes
        state: present
  - name: load kernel modules
    community.general.modprobe:
        name: "{{ item }}"
    loop:
        - overlay
        - br_netfilter
  - name: sysctl configuration
    ansible.posix.sysctl:
        name: "{{ item }}"
        value: 1
    loop:
        - net.bridge.bridge-nf-call-iptables
        - net.bridge.bridge-nf-call-ip6tables
        - net.ipv4.ip_forward
  - name: install containerd
    ansible.builtin.apt:
        name: containerd
  - name: create containerd directory
    ansible.builtin.file:
        path: /etc/containerd
        state: directory
  - name: containerd configuration
    ansible.builtin.shell: containerd config default > /etc/containerd/config.toml
    args:
        creates: /etc/containerd/config.toml
  - name: restart containerd service
    ansible.builtin.systemd:
        name: containerd
        state: restarted
- name: Install Kubernetes
  hosts:
      - controller
      - workers
  become: true
  vars:
      kubernetes_version: 1.24.0-00
  tasks:
  - name: Add an Apt signing key
    ansible.builtin.apt_key:
     url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
     state: present

  - name: Add specified repository into sources list
    ansible.builtin.apt_repository:
     repo: deb https://apt.kubernetes.io/ kubernetes-xenial main
     state: present
  - name: Install Kubernetes
    ansible.builtin.apt:
        update_cache: yes
        state: present
        pkg: 
            - kubelet={{ kubernetes_version }}
            - kubeadm={{ kubernetes_version }}
            - kubectl={{ kubernetes_version }}

  - name:
